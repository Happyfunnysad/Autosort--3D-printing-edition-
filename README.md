# Автосортировка 3D-файлов на macOS

Автоматическая сортировка файлов для 3D-печати из папки Загрузки в отдельную папку. Скрипт проверяет расширения файлов (STL, OBJ, 3MF и др.) и может фильтровать по источнику скачивания.

## Возможности

- ✅ Автоматическое перемещение файлов для 3D-печати
- ✅ Поддержка папок (проверяет содержимое рекурсивно)
- ✅ Фильтрация по источнику скачивания (опционально)
- ✅ Цветные метки для обработанных файлов
- ✅ Подробное логирование
- ✅ Безопасное перемещение (не перезаписывает существующие файлы)

## Поддерживаемые форматы

- STL
- OBJ
- 3MF
- GCODE
- LYS
- CTB

Вы можете добавить свои форматы в файл `config.sh`.

## Установка

### Быстрая установка

1. Откройте терминал и перейдите в папку проекта:
```bash
cd "/Users/aaabbb/projects/3d print sort"
```

2. Запустите скрипт установки:
```bash
./setup.sh
```

Скрипт установки автоматически:
- Установит права доступа на скрипты
- Создаст целевую папку для 3D-файлов
- Настроит cron для автоматического запуска каждые 5 минут
- Покажет инструкции по настройке прав доступа

### Настройка прав доступа (ОБЯЗАТЕЛЬНО!)

Для работы скрипта через cron необходимо предоставить доступ к файлам:

1. Откройте **Системные настройки** → **Конфиденциальность и безопасность**
2. Перейдите в раздел **Управление доступом к диску** (Full Disk Access)
3. Нажмите кнопку **+** (замок должен быть разблокирован)
4. Нажмите **Cmd + Shift + G** и введите: `/usr/sbin/cron`
5. Выберите файл **cron** и нажмите **Открыть**
6. Убедитесь, что переключатель **включен**

**Без этого шага скрипт не сможет читать файлы из папки Загрузки!**

## Настройка

Отредактируйте файл `config.sh` для изменения настроек:

```bash
nano config.sh
```

### Основные параметры:

- `SOURCE_DIR` - папка, которую нужно отслеживать (по умолчанию: `~/Downloads`)
- `TARGET_DIR` - папка назначения (по умолчанию: `~/Documents/3D_Models`)
- `EXTS` - список расширений файлов через `|` (например: `"stl|obj|3mf"`)
- `ENABLE_SOURCE_FILTER` - включить фильтрацию по источнику (`true`/`false`)
- `SOURCE_DOMAINS` - массив доменов для фильтрации (например: `"printables.com"`)

### Примеры настройки

#### Сортировка всех 3D-файлов (без фильтра по источнику):
```bash
ENABLE_SOURCE_FILTER=false
```

#### Сортировка только файлов с Printables и Thingiverse:
```bash
ENABLE_SOURCE_FILTER=true
SOURCE_DOMAINS=(
    "printables.com"
    "thingiverse.com"
)
```

#### Изменение интервала запуска cron:
В файле `config.sh` измените `CRON_INTERVAL`:
- `"*/5"` - каждые 5 минут
- `"*/10"` - каждые 10 минут
- `"0 * * * *"` - каждый час
- `"0 */2 * * *"` - каждые 2 часа

После изменения настроек перезапустите cron задачу:
```bash
./setup.sh
```

## Использование

### Автоматический режим

После установки скрипт будет автоматически запускаться через cron. Просто скачайте файл в папку Загрузки, и он будет перемещен в течение нескольких минут.

### Ручной запуск

Для немедленной проверки и сортировки:
```bash
./sort_3d.sh
```

### Просмотр логов

```bash
# Просмотр последних записей
tail -20 /tmp/sort_3d.log

# Отслеживание в реальном времени
tail -f /tmp/sort_3d.log
```

## Управление cron

### Просмотр текущих задач:
```bash
crontab -l
```

### Редактирование задач:
```bash
crontab -e
```

### Удаление задачи автосортировки:
```bash
crontab -l | grep -v "sort_3d.sh" | crontab -
```

## Решение проблем

### Скрипт не перемещает файлы

1. **Проверьте права доступа:**
   - Убедитесь, что cron добавлен в "Управление доступом к диску"
   - Проверьте, что скрипт имеет права на выполнение: `chmod +x sort_3d.sh`

2. **Проверьте логи:**
   ```bash
   cat /tmp/sort_3d.log
   ```

3. **Проверьте конфигурацию:**
   - Убедитесь, что пути в `config.sh` правильные
   - Проверьте, что целевая папка существует

4. **Проверьте cron:**
   ```bash
   crontab -l
   ```
   Убедитесь, что задача присутствует

### Файлы не перемещаются при фильтрации по источнику

- Метаданные источника могут отсутствовать, если файл был скачан не через браузер
- Попробуйте отключить фильтр по источнику: `ENABLE_SOURCE_FILTER=false`
- Проверьте метаданные вручную: `mdls -name kMDItemWhereFroms /path/to/file`

### Скрипт работает медленно

- Уменьшите частоту запуска cron (например, до `*/10` или `*/15`)
- Убедитесь, что в папке Загрузки не слишком много файлов

### Цветные метки не устанавливаются

- Это не критично, скрипт продолжит работать
- Метки требуют доступа к Finder через AppleScript
- Если метки важны, убедитесь, что скрипт запускается от вашего пользователя

## Структура проекта

```
3d print sort/
├── sort_3d.sh      # Основной скрипт сортировки
├── config.sh       # Файл конфигурации
├── setup.sh        # Скрипт установки
└── README.md       # Эта инструкция
```

## Безопасность

- Скрипт использует безопасное перемещение (`mv -n`), которое не перезаписывает существующие файлы
- Все действия логируются в `/tmp/sort_3d.log`
- Скрипт не удаляет файлы, только перемещает их

## Лицензия

Свободное использование. Модифицируйте под свои нужды.

## Поддержка

При возникновении проблем:
1. Проверьте логи: `tail -f /tmp/sort_3d.log`
2. Убедитесь, что все настройки в `config.sh` корректны
3. Проверьте права доступа cron в Системных настройках

